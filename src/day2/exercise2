from datetime import datetime
from sqlalchemy import create_engine, Column, Integer, String, Boolean, Float, DateTime, ForeignKey
from sqlalchemy.orm import declarative_base, Session, relationship
import random

# PoÅ‚Ä…czenie z bazÄ…
engine = create_engine("sqlite:///experiments.db", echo=True)
Base = declarative_base()


# Tabele z relacjÄ… jeden-do-wielu
class Experiment(Base):
    __tablename__ = "experiment"
    id = Column(Integer, primary_key=True)
    title = Column(String, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    type = Column(Integer)
    finished = Column(Boolean, default=False)

    # Relacja: jeden Experiment ma wiele DataPoint
    data_points = relationship("DataPoint", back_populates="experiment", cascade="all, delete-orphan")

    def __repr__(self):
        return f"<Experiment(id={self.id}, title='{self.title}', type={self.type}, finished={self.finished})>"


class DataPoint(Base):
    __tablename__ = "data_point"
    id = Column(Integer, primary_key=True)
    real_value = Column(Float)
    target_value = Column(Float)
    experiment_id = Column(Integer, ForeignKey("experiment.id"))  # klucz obcy

    # Relacja zwrotna do Experiment
    experiment = relationship("Experiment", back_populates="data_points")

    def __repr__(self):
        return f"<DataPoint(id={self.id}, real_value={self.real_value}, target_value={self.target_value}, experiment_id={self.experiment_id})>"


# ðŸ”¹ Utworzenie tabel (czysta baza)
Base.metadata.drop_all(engine)  # usuwa poprzednie tabele
Base.metadata.create_all(engine)  # tworzy nowe tabele


# ðŸ”¹ Operacje na danych
with Session(engine) as session:

    # Dodanie 2 wierszy do tabeli Experiment
    experiments = [
        Experiment(title="Test A", type=random.randint(1, 3)),
        Experiment(title="Test B", type=random.randint(1, 3)),
    ]
    session.add_all(experiments)
    session.commit()  # zapisujemy, aby mieÄ‡ ID do relacji

    # Dodanie 10 DataPointÃ³w przypisanych do pierwszego Experiment
    data_points = [
        DataPoint(real_value=random.uniform(0, 100), target_value=random.uniform(0, 100), experiment=experiments[0])
        for _ in range(10)
    ]
    session.add_all(data_points)
    session.commit()

    # Pobranie i wyÅ›wietlenie danych z relacjÄ…
    print("\n--- Experiments z DataPoints ---")
    for exp in session.query(Experiment).all():
        print(exp)
        for dp in exp.data_points:
            print("   ", dp)

    # Aktualizacja wszystkich wierszy w Experiments -> finished=True
    session.query(Experiment).update({Experiment.finished: True})
    session.commit()

    print("\n--- Experiments po aktualizacji finished=True ---")
    for exp in session.query(Experiment).all():
        print(exp)

    # UsuniÄ™cie wszystkich wierszy (przez kaskadÄ™ DataPoints zostanÄ… teÅ¼ usuniÄ™te)
    # session.query(Experiment).delete()
    # session.commit()
    # print("\nâœ… Wszystkie wiersze zostaÅ‚y usuniÄ™te.")
